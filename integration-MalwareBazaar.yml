category: Data Enrichment & Threat Intelligence
commonfields:
  id: MalwareBazaar
  version: -1
configuration:
- additionalinfo: This is the API endpoint for the MalwareBazaar API.
  defaultvalue: https://mb-api.abuse.ch
  display: Server URL
  name: url
  required: true
  type: 0
- additionalinfo: API key is required only to add a comment to a malware sample.
  display: User Name
  displaypassword: API Key
  hiddenusername: true
  name: credentials
  required: false
  type: 9
- additionalinfo: Reliability of the source providing the intelligence data.
  defaultvalue: A - Completely reliable
  display: Source Reliability
  name: integrationReliability
  options:
  - A+ - 3rd party enrichment
  - A - Completely reliable
  - B - Usually reliable
  - C - Fairly reliable
  - D - Not usually reliable
  - E - Unreliable
  - F - Reliability cannot be judged
  required: true
  type: 15
- display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.0.0
    itemVersion: 1.0.15
    packID: MalwareBazaar
    packName: MalwareBazaar
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: MalwareBazaar is a project from abuse.ch with the goal of sharing malware
  samples with the Infosec community, AV vendors, and threat intelligence providers.
detaileddescription: "## MalwareBazaar\n\nMalwareBazaar offers an API to download
  malware samples, comment malware samples and obtain intel based on the file hash,
  tag, signature, file type, etc.\n\nAn API key is required only to comment a malware
  sample.\n\n### Get an API Key\nObtaining an API key can be done by:\n1. [logging](https://bazaar.abuse.ch/login/)
  in to MalwareBazaar with your Twitter account. \n2. Accessing the API key in your
  [Account settings](https://bazaar.abuse.ch/account/).\n\n\n\n\n---\n[View Integration
  Documentation](https://xsoar.pan.dev/docs/reference/integrations/malware-bazaar)"
display: MalwareBazaar
image: data:image/png;base64,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
name: MalwareBazaar
script:
  commands:
  - arguments:
    - default: true
      description: A list of SHA256, MD5, or SHA1 hashes of the malware samples you
        want to query.
      isArray: true
      name: file
      required: true
    description: Check if a particular malware sample is known to MalwareBazaar.
    name: file
    outputs:
    - contextPath: MalwareBazaar.File.sha256_hash
      description: SHA256 hash of the malware sample.
      type: String
    - contextPath: MalwareBazaar.File.sha3_384_hash
      description: SHA3-384 hash of the malware sample.
      type: String
    - contextPath: MalwareBazaar.File.sha1_hash
      description: SHA1 hash of the malware sample.
      type: String
    - contextPath: MalwareBazaar.File.md5_hash
      description: MD5 hash of the malware sample.
      type: String
    - contextPath: MalwareBazaar.File.first_seen
      description: Timestamp of when the file was first seen by MalwareBazaar in UTC
        format.
      type: Date
    - contextPath: MalwareBazaar.File.last_seen
      description: Timestamp of when the file was last seen by MalwareBazaar in UTC
        format.
      type: Date
    - contextPath: MalwareBazaar.File.file_name
      description: Malware sample's file name.
      type: String
    - contextPath: MalwareBazaar.File.file_size
      description: Malware sample's file size in bytes.
      type: Number
    - contextPath: MalwareBazaar.File.file_type_mime
      description: Malware samples's MIME file type.
      type: String
    - contextPath: MalwareBazaar.File.file_type
      description: Malware sample's file type.
      type: String
    - contextPath: MalwareBazaar.File.reporter
      description: Twitter handle of the report (or anonymous for anonymous submissions).
      type: String
    - contextPath: MalwareBazaar.File.origin_country
      description: Two letter country code of the country where the sample was uploaded
        from.
      type: String
    - contextPath: MalwareBazaar.File.anonymous
      description: Whether the submission of the sample was anonymous - 1 (true) or
        0 (false).
      type: Number
    - contextPath: MalwareBazaar.File.signature
      description: Malware family (if available).
      type: String
    - contextPath: MalwareBazaar.File.imphash
      description: Import hash (imphash) (only available for Portable Executables).
      type: String
    - contextPath: MalwareBazaar.File.tlsh
      description: Trend Micro Locality Sensitive Hash (tlsh).
      type: String
    - contextPath: MalwareBazaar.File.telfhash
      description: Trend Micro ELF Hash (telfhash).
      type: String
    - contextPath: MalwareBazaar.File.ssdeep
      description: The SSDeep hash of the file.
      type: String
    - contextPath: MalwareBazaar.File.dhash_icon
      description: In case the file is a Portable Executable, the dhash of the sample's
        icon.
      type: Unknown
    - contextPath: MalwareBazaar.File.comment
      description: Comment in the malware sample.
      type: String
    - contextPath: MalwareBazaar.File.tags
      description: List of tags in the malware sample.
      type: String
    - contextPath: MalwareBazaar.File.code_sign.subject_cn
      description: Subject common name (CN).
      type: String
    - contextPath: MalwareBazaar.File.code_sign.issuer_cn
      description: Issuer common name (CN).
      type: String
    - contextPath: MalwareBazaar.File.code_sign.algorithm
      description: Algorithm used.
      type: String
    - contextPath: MalwareBazaar.File.code_sign.valid_from
      description: Datetime from which the code sign was valid.
      type: Date
    - contextPath: MalwareBazaar.File.code_sign.valid_to
      description: Datetime until which the code sign was valid (expiry date).
      type: Date
    - contextPath: MalwareBazaar.File.code_sign.serial_number
      description: Serial number of the code sign.
      type: String
    - contextPath: MalwareBazaar.File.code_sign.cscb_listed
      description: Whether the sample is listed in the Code Signing Certificate Blocklist
        (CSCB).
      type: String
    - contextPath: MalwareBazaar.File.code_sign.cscb_reason
      description: Code Signing Certificate Blocklist (CSCB) listing reason.
      type: String
    - contextPath: MalwareBazaar.File.delivery_method
      description: How the file was distributed.
      type: String
    - contextPath: MalwareBazaar.File.file_information
      description: Contextual information about the file sample.
      type: Unknown
    - contextPath: MalwareBazaar.File.yara_rules.rule_name
      description: Name of the YARA rule that triggered the malware.
      type: String
    - contextPath: MalwareBazaar.File.yara_rules.author
      description: Author of the YARA rule.
      type: String
    - contextPath: MalwareBazaar.File.yara_rules.description
      description: Description of the YARA rule.
      type: String
    - contextPath: MalwareBazaar.File.yara_rules.reference
      description: Reference of the YARA rule.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.ANY.RUN
      description: Dynamic malware analysis from ANY.RUN.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.CAPE
      description: Dynamic malware analysis from CAPE sandbox.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.CERT-PL_MWDB
      description: Threat intel from CERT.PL Malware database.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.vxCube
      description: Dynamic malware analysis from Dr.Web vxCube.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.DocGuard
      description: Office document reputation from DocGuad.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.FileScan-IO
      description: Malware analysis service from FileScan.IO.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.InQuest Labs
      description: File reputation service from InQuest Labs.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.Intezer
      description: Code analysis from Intezer.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.ReversingLabs
      description: File reputation and intelligence from ReversingLabs TitaniumCloud.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.Spamhaus_HBL
      description: File reputation from Spamhaus Hash Blocklist (HBL).
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.Triage
      description: Dynamic malware analysis from Hatching Triage.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.UnpacMe
      description: Malware unpacking service from UnpacMe.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.VMRay
      description: Dynamic malware analysis from VMRay.
      type: Unknown
    - contextPath: MalwareBazaar.File.vendor_intel.YOROI_YOMI
      description: Dynamic malware analysis from YOROI YOMI.
      type: Unknown
    - contextPath: MalwareBazaar.File.comments.id
      description: Unique ID that identifies this comment.
      type: String
    - contextPath: MalwareBazaar.File.comments.date_added
      description: Timestamp (UTC) of when this comment was made.
      type: Date
    - contextPath: MalwareBazaar.File.comments.twitter_handle
      description: Twitter handle who wrote this comment.
      type: String
    - contextPath: MalwareBazaar.File.comments.display_name
      description: Twitter display name.
      type: String
    - contextPath: MalwareBazaar.File.comments.comment
      description: The comment itself.
      type: String
    - contextPath: DBotScore.Indicator
      description: The indicator that was tested.
      type: String
    - contextPath: DBotScore.Score
      description: The actual score.
      type: Number
    - contextPath: DBotScore.Type
      description: Type of indicator.
      type: String
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score.
      type: String
    - contextPath: DBotScore.Reliability
      description: The reliability of the vendor.
      type: String
    - contextPath: File.MD5
      description: MD5 hash of the file submitted for analysis.
      type: String
    - contextPath: File.SHA1
      description: SHA1 hash of the file submitted for analysis.
      type: String
    - contextPath: File.SHA256
      description: SHA256 hash of the file submitted for analysis.
      type: String
    - contextPath: File.Size
      description: Size of the file submitted for analysis.
      type: String
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision.
      type: String
    - contextPath: File.Malicious.Description
      description: For malicious files, the reason that the vendor made the decision.
      type: String
    - contextPath: File.Relationships.EntityA
      description: The source of the relationship.
      type: string
    - contextPath: File.Relationships.EntityB
      description: The destination of the relationship.
      type: string
    - contextPath: File.Relationships.Relationship
      description: The name of the relationship.
      type: string
    - contextPath: File.Relationships.EntityAType
      description: The type of the source of the relationship.
      type: string
    - contextPath: File.Relationships.EntityBType
      description: The type of the destination of the relationship.
      type: string
  - arguments:
    - description: SHA256 hash of the malware sample to download.
      name: sha256_hash
      required: true
    description: Download a malware sample from MalwareBazaar. Any malware sample
      downloaded from MalwareBazaar is zipped and password protected using the password
      "infected" (without "").
    execution: true
    name: malwarebazaar-download-sample
    outputs:
    - contextPath: File.Size
      description: The size of the file.
      type: String
    - contextPath: File.SHA1
      description: The SHA1 hash of the file.
      type: String
    - contextPath: File.SHA256
      description: The SHA256 hash of the file.
      type: String
    - contextPath: File.SHA512
      description: The SHA512 hash of the file.
      type: String
    - contextPath: File.Name
      description: The name of the file.
      type: String
    - contextPath: File.SSDeep
      description: The SSDeep hash of the file.
      type: String
    - contextPath: File.EntryID
      description: Entry ID of the file.
      type: String
    - contextPath: File.Info
      description: Information about the file.
      type: String
    - contextPath: File.Type
      description: The file type.
      type: String
    - contextPath: File.MD5
      description: The MD5 hash of the file.
      type: String
    - contextPath: File.Extension
      description: The extension of the file.
      type: String
  - arguments:
    - description: SHA256 hash of the malware sample to add a comment.
      name: sha256_hash
      required: true
    - description: The comment to add to the sample.
      name: comment
      required: true
    description: Add a comment for a malware sample.
    name: malwarebazaar-comment-add
    outputs:
    - contextPath: MalwareBazaar.MalwarebazaarCommentAdd.sha256_hash
      description: SHA256 hash of given file.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarCommentAdd.comment
      description: The comment that was added to the malware sample.
      type: String
  - arguments:
    - auto: PREDEFINED
      description: Type of the sample.
      name: sample_type
      predefined:
      - tag
      - signature
      - file_type
      - clamav
      - imphash
      - yara_rule
      - issuer_cn
      required: true
    - description: Value of the sample selected.
      name: sample_value
      required: true
    - description: Maximum number of results to return. Default is 1000. Note that
        when using the issuer_cn argument, all relevant results will display (maximum
        100).
      name: limit
    - description: Page number to view. Each page contains page_size values. Must
        be used along with the page_size argument.
      name: page
    - description: Number of results per page to display.
      name: page_size
    description: Retrieves a list of recent malware samples (maximum 1000) associated
      with a specific sample type. Note that you can either use the limit argument
      or the page and page_size argument.
    name: malwarebazaar-samples-list
    outputs:
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.sha256_hash
      description: SHA256 hash of the malware sample.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.sha3_384_hash
      description: SHA3-384 hash of the malware sample.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.sha1_hash
      description: SHA1 hash of the malware sample.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.md5_hash
      description: MD5 hash of the malware sample.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.first_seen
      description: Timestamp of when the file was first seen by MalwareBazaar (UTC).
      type: Date
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.last_seen
      description: Timestamp of when the file was last seen by MalwareBazaar (UTC).
      type: Date
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.file_name
      description: Malware sample's file name.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.file_size
      description: File size in bytes.
      type: Number
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.file_type_mime
      description: MIME file type.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.file_type
      description: File type.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.reporter
      description: Twitter handle of the report (or anonymous for anonymous submissions).
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.anonymous
      description: Whether the submission of the sample was anonymous - 1 (true) or
        0 (false).
      type: Number
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.signature
      description: Malware family (if available).
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.imphash
      description: Import hash (imphash) of the sample (only available for Portable
        Executables).
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.tlsh
      description: Trend Micro Locality Sensitive Hash (tlsh) of the sample.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.telfhash
      description: Trend Micro ELF Hash (telfhash) of the sample.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.ssdeep
      description: The SSDeep hash of the sample.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.dhash_icon
      description: In case the file is a Portable Executable, the dhash of the samples
        icon.
      type: Unknown
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.tags
      description: List of tags.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.code_sign.subject_cn
      description: Subject common name (CN).
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.code_sign.issuer_cn
      description: Issuer common name (CN).
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.code_sign.algorithm
      description: Algorithm used.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.code_sign.valid_from
      description: Datetime from which the code sign was valid.
      type: Date
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.code_sign.valid_to
      description: Datetime until which the code sign was valid (expiry date).
      type: Date
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.code_sign.serial_number
      description: Serial number of the code sign.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.code_sign.cscb_listed
      description: Whether the sample is listed in the Code Signing Certificate Blocklist
        (CSCB).
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.code_sign.cscb_reason
      description: Code Signing Certificate Blocklist (CSCB) listing reason.
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.intelligence.clamav
      description: List of ClamAV detections (official and unofficial rules).
      type: String
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.intelligence.downloads
      description: Number of downloads from MalwareBazaar.
      type: Number
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.intelligence.uploads
      description: Number of uploads to MalwareBazaar.
      type: Number
    - contextPath: MalwareBazaar.MalwarebazaarSamplesList.intelligence.mail
      description: Indicates if this malware sample has been seen in global spam traffic.
      type: String
  dockerimage: demisto/python3:3.10.12.68714
  runonce: false
  script: |
    register_module_line('MalwareBazaar', 'start', __line__())
    ### pack version: 1.0.15


    import copy
    import urllib3

    QUERIES = {
        "tag": "get_taginfo",
        "signature": "get_siginfo",
        "file_type": "get_file_type",
        "clamav": "get_clamavinfo",
        "imphash": "get_imphash",
        "yara_rule": "get_yarainfo",
        "issuer_cn": "get_issuerinfo"
    }

    EXCEPTIONS_MESSAGES = {
        'illegal_sha256_hash': 'Illegal SHA256 hash provided.',
        'file_not_found': 'The file was not found or is unknown to MalwareBazaar.',
        'hash_not_found': 'The file (hash) you wanted to query is unknown to MalwareBazaar.',
        'illegal_hash': 'The hash you provided is not a valid SHA256 hash.',
        'user_blacklisted': 'Your API key is blacklisted.',
        'no_results': 'Your query yield no results.',
        'not_found': 'Tha value you wanted to query is unknown to MalwareBazaar.',
        'illegal': 'The text you provided is not valid.'
    }

    VENDOR_NAME = 'MalwareBazaar'

    LIST_HEADERS = ['md5_hash', 'sha256_hash', 'sha1_hash', 'file_name', 'file_type', 'file_size', 'tags', 'first_seen',
                    'last_seen']

    FILE_HEADERS = ['md5_hash', 'sha256_hash', 'sha1_hash', 'file_name', 'file_type', 'file_size', 'tags', 'first_seen',
                    'last_seen', 'signature', 'ssdeep', 'reporter', 'imphash', 'yara_rules_names']


    class Client(BaseClient):
        def __init__(self, server_url, verify, proxy, headers, api_key):
            self.api_key = api_key
            super().__init__(base_url=server_url, verify=verify, proxy=proxy, headers=headers)

        def file_request(self, hash):
            response = self._http_request('POST',
                                          files={
                                              'query': (None, "get_info"),
                                              'hash': (None, hash)
                                          })
            return response

        def malwarebazaar_download_sample_request(self, sha256_hash):
            response = self._http_request('POST',
                                          files={
                                              'query': (None, "get_file"),
                                              'sha256_hash': (None, sha256_hash)
                                          },
                                          resp_type="response")
            return response

        def malwarebazaar_comment_add_request(self, sha256_hash, comment):
            if self.api_key is None:
                raise Exception('API Key is required for this command')
            response = self._http_request('POST',
                                          headers={"API-KEY": self.api_key},
                                          files={
                                              'query': (None, "add_comment"),
                                              'sha256_hash': (None, sha256_hash),
                                              'comment': (None, comment)
                                          })
            return response

        def malwarebazaar_samples_list_request(self, sample_input, value, limit, query):
            files = {
                'query': (None, query),
                sample_input: (None, value),
            }
            if not sample_input == 'issuer_cn':
                files.update({'limit': (None, limit)})
            response = self._http_request('POST',
                                          files=files)
            return response


    def file_process(hash, reliability, raw_response, response_data) -> CommandResults:
        """
        creates CommandResults for every file in the list inserted to file_command
        Args:
            hash:
            raw_response:
            response_data:

        Returns:
        CommandResults for the relevant file
        """
        dbot_score = Common.DBotScore(
            indicator=hash,
            indicator_type=DBotScoreType.FILE,
            integration_name=VENDOR_NAME,
            score=Common.DBotScore.BAD,
            reliability=reliability,
            malicious_description=response_data.get('comment')
        )

        signature = response_data.get('signature')
        relationship = EntityRelationship(name='indicator-of',
                                          entity_a=hash,
                                          entity_a_type='File',
                                          entity_b=signature,
                                          entity_b_type=FeedIndicatorType.indicator_type_by_server_version(
                                              "STIX Malware"),
                                          source_reliability=reliability,
                                          brand=VENDOR_NAME)

        table_name = f'{VENDOR_NAME} File reputation for: {hash}'

        humam_readable_data = copy.deepcopy(response_data)
        humam_readable_data.update({'yara_rules_names': []})
        rules = humam_readable_data.get('yara_rules', [])
        rules = rules if rules else []
        for rule in rules:
            humam_readable_data.get('yara_rules_names').append(rule.get('rule_name'))

        md = tableToMarkdown(table_name, t=humam_readable_data, headerTransform=string_to_table_header, removeNull=True,
                             headers=FILE_HEADERS)

        file_object = Common.File(md5=response_data.get('md5_hash'), sha256=response_data.get('sha256_hash'),
                                  sha1=response_data.get('sha1_hash'), size=response_data.get('file_size'),
                                  file_type=response_data.get('file_type'), dbot_score=dbot_score,
                                  relationships=[relationship])

        return CommandResults(
            outputs_prefix='MalwareBazaar.File',
            outputs_key_field='md5_hash',
            outputs=response_data,
            raw_response=raw_response,
            indicator=file_object,
            relationships=[relationship],
            readable_output=md
        )


    def check_query_status(response, is_list_command=False, sample_type=None):
        """
        checks whether the request to the API returned with the proper result
        Args:
            sample_type: string, type of sample (tag, signature, etc.)
            is_list_command: bool
            response: response from API

        """
        not_found_error = '_not_found'
        illegal_error = 'illegal_'
        query_status = response.get("query_status")
        if not query_status == "ok" and not query_status == "success":
            if is_list_command:
                if query_status == sample_type + not_found_error:
                    raise Exception(EXCEPTIONS_MESSAGES.get('not_found'))
                if query_status == sample_type + illegal_error:
                    raise Exception(EXCEPTIONS_MESSAGES.get('illegal'))
            if query_status in EXCEPTIONS_MESSAGES:
                raise Exception(EXCEPTIONS_MESSAGES.get(query_status))
            else:
                raise Exception(query_status)


    def file_command(client: Client, args: Dict[str, Any]) -> List[CommandResults]:
        """

        Args:
            client:
            args: file - list of files hash

        Returns:
            file reputation for the given hashes
        """

        reliability = demisto.params().get('integrationReliability', DBotScoreReliability.A)
        if DBotScoreReliability.is_valid_type(reliability):
            reliability = DBotScoreReliability.get_dbot_score_reliability_from_str(reliability)
        else:
            raise Exception("Please provide a valid value for the Source Reliability parameter.")

        file_list = argToList(args.get('file'))
        command_results: List[CommandResults] = []
        for hash in file_list:
            raw_response = client.file_request(hash)
            if raw_response.get('query_status') == 'hash_not_found':
                command_results.append(create_indicator_result_with_dbotscore_unknown(hash, DBotScoreType.FILE, reliability))
            else:
                check_query_status(raw_response)
                response_data = raw_response.get('data')[0]
                if file_name := response_data.get('file_name'):
                    response_data['file_name'] = '' if file_name == 'file' else file_name
                command_results.append(file_process(hash, reliability, raw_response, response_data))
        return command_results


    def malwarebazaar_download_sample_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """

        Args:
            client:
            args: sha256_hash of file

        Returns:
            zip file contains the malware sample from MalwareBazaar
        """
        sha256_hash = args.get("sha256_hash")
        response = client.malwarebazaar_download_sample_request(sha256_hash)
        filename = f'{sha256_hash}.zip'
        return fileResult(filename, response.content)


    def malwarebazaar_comment_add_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """

        Args:
            client:
            args: sha256_hash of file, comment to add in context of this file

        Returns:
            query status of the request to MalwareBazaar (success or error)
        """
        sha256_hash = args.get("sha256_hash")
        comment = args.get("comment")
        response = client.malwarebazaar_comment_add_request(sha256_hash, comment)
        check_query_status(response)

        readable_output = f'Comment added to {sha256_hash} malware sample successfully'
        outputs = {
            'sha256_hash': sha256_hash,
            'comment': comment,
        }
        return CommandResults(
            outputs_prefix='MalwareBazaar.MalwarebazaarCommentAdd',
            outputs_key_field='sha256_hash',
            outputs=outputs,
            readable_output=readable_output,
            raw_response=response,
        )


    def malwarebazaar_samples_list_command(client: Client, args: Dict[str, Any]) -> CommandResults:
        """

        Args:
            client:
            args: sample_type - {clamav, file_type, imphash, signature, tag, yara_rule}
                  sample_value
                  limit (optional) - number of results (default 50)

        Returns:
            query results from API
        """
        sample_input = args.get("sample_type") or ''
        value = args.get("sample_value")

        limit = arg_to_number(args.get("limit")) if "limit" in args else None
        page = arg_to_number(args.get("page")) if "page" in args else None
        page_size = arg_to_number(args.get("page_size")) if "page_size" in args else None

        # # if limit was provided, request limit results from api, else, use pagination (if nothing is used 50 results will
        # # be requested as default)
        if limit is None:
            if page is not None and page_size is not None:
                if page <= 0:
                    raise Exception('Chosen page number must be greater than 0')
                limit = page_size * page
            else:
                limit = 50

        # # 1000 is the maximal value we can get from tha API
        limit = min(limit, 1000)

        query = QUERIES.get(sample_input)
        response = client.malwarebazaar_samples_list_request(sample_input, value, limit, query)
        check_query_status(response, True, args.get('sample_type'))

        response_data = response.get('data')

        # take required results from response if pagination by page and page_size
        if page is not None and page_size is not None:
            response_data = response_data[-1 * page_size:]

        readable_output = tableToMarkdown('Sample List', t=response_data, headerTransform=string_to_table_header,
                                          removeNull=True, headers=LIST_HEADERS)
        return CommandResults(
            outputs_prefix='MalwareBazaar.MalwarebazaarSamplesList',
            outputs_key_field='sha256_hash',
            readable_output=readable_output,
            outputs=response_data,
            raw_response=response
        )


    def test_module(client: Client) -> None:
        if client.api_key:
            response = client.malwarebazaar_comment_add_request(
                "094fd325049b8a9cf6d3e5ef2a6d4cc6a567d7d49c35f8bb8dd9e3c6acf3d78d",
                "test comment")
        else:
            response = client.malwarebazaar_samples_list_request('tag', 'TrickBot', '2', QUERIES.get('tag'))
        check_query_status(response)
        return_results('ok')


    def main() -> None:
        params: Dict[str, Any] = demisto.params()
        args: Dict[str, Any] = demisto.args()
        url = params.get('url')
        api_key = params.get('credentials', {}).get('password') or None
        verify_certificate: bool = not params.get('insecure', False)
        proxy = params.get('proxy', False)

        command = demisto.command()
        demisto.debug(f'Command being called is {command}')

        try:
            urllib3.disable_warnings()
            client: Client = Client(urljoin(url, '/api/v1/'), verify_certificate, proxy, headers={}, api_key=api_key)

            commands = {
                'file': file_command,
                'malwarebazaar-download-sample': malwarebazaar_download_sample_command,
                'malwarebazaar-comment-add': malwarebazaar_comment_add_command,
                'malwarebazaar-samples-list': malwarebazaar_samples_list_command,
            }

            if command == 'test-module':
                test_module(client)
            elif command in commands:
                return_results(commands[command](client, args))
            else:
                raise NotImplementedError(f'{command} command is not implemented.')

        except Exception as e:
            return_error(str(e))


    if __name__ in ['__main__', 'builtin', 'builtins']:
        main()

    register_module_line('MalwareBazaar', 'end', __line__())
  subtype: python3
  type: python
system: true
