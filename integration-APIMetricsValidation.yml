category: Utilities
commonfields:
  id: APIMetricsValidation
  version: -1
configuration:
- defaultvalue: okay
  display: This is not needed
  name: testing
  required: true
  section: Connect
  type: 0
contentitemexportablefields:
  contentitemfields:
    definitionid: ""
    fromServerVersion: 6.8.0
    itemVersion: 1.3.15
    packID: DeveloperTools
    packName: Developer Tools
    packPropagationLabels:
    - all
    prevname: ""
    propagationLabels: []
    toServerVersion: ""
description: This integration runs through all scenarios as defined in the API Metrics
  expected results guide.
detaileddescription: |-
  ### Community Contributed Integration
   #### Integration Author: Cortex XSOAR
   No support or maintenance is provided by the author. Customers are encouraged to engage with the user community for questions and guidance at the [Cortex XSOAR Live Discussions](https://live.paloaltonetworks.com/t5/cortex-xsoar-discussions/bd-p/Cortex_XSOAR_Discussions).
  ***
  ### Metrics Validation Tool
  All commands should be executed only once. After they are all executed, refer to the **Metrics Test Cases Validation** dashboard and verify all test case assertions
  are green.
display: APIMetricsValidation (Community Contribution)
image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHgAAAAyCAYAAACXpx/YAAAABGdBTUEAALGPC/xhBQAACYJJREFUeAHtmwmMVdUdhw8zDDMKjIAgIohIRUaghBSLGmWJWGONaAON2CUmik2pTRu7poCEqq3VtjY2FlvcWqRY1BRJwaWtSSmWxYgooAiOwAAKZREBkZ2Zft+bd8jlOW8YMhSYy/sl39yz3bP8/+eee++5b0IoqGCBlFhgJON4GWbBNSkZU2EYWQtcFYqbVYVfXLUwjB+0IDQLG0jveypYp+hUGCRjHBqG9awKX+jeP9xQcUno32kFaVecCmM/VRy8MPx7TeusQ6vDko2dCS8qOLjpWqA5XX8YtsAemBq27zkn1ITqsHHn5rCvWgd7LzZ/JUyAVKpZKkcVwujQqsXtYcrwtqFjqw6ZMZYWtcDBtePdX7037Nz3SSZ93fZNYfTMEpw+hvizabNHWpfo/mFEr4/CueVdQoui0gzRuXqwhLS2Ze0y9O1YEa69cB2pl6XNuY7HpSyNKsKpR16dDlTvD9v3bgunl1i2JI2GSJODb8JBo+Aj6BCKmtXv4MmL54aHXu2dderFHJ/LhlN1SIuDB/Kee3+4d+iWULm1NDz9VjmvRG3yemrzrk04twf5A6AS2oMPXKlTWhw8jPvoqjC0+xDgEcsLsh7NXbua3I2gc1UqnevA0vKQtSwsWl/GM3JN2HPgkzB1ybzgk3I+9Wjn1d0L0jLB8400+9qQN7vJZLSipzN4sDofx7bEzcVh7BXvheG9Ls07guHT5oe1O/aTPw909n0wH1Kl4pSMZh/jmBoO1rzE0Q2ObqFfpzNCv7O75h3fyD6dQ3npBl6VOoWS4tPC5l1nUfbFvOWbaEaalqiD+GD5IT/UHArlCxSFm/rUvvs+uGBOWLY5LZP9sPGm5R582KCIvB/mrNbhDdPsKt+BqxpWuGmVqv9dsWmNJdnbc4jMDWXNd4fWLXZmMrqU7wqPXT+Ie/SBcPP0BWHz7paZ9J1725K2g/Bg2J5JS9GfNC3RSbesJ9KbJ+qLwQewPuHD3d/lHl2d+eBQubWC452krwKd+ib4wJU6pXWJ1lG7YA68AGew8VHJ7lZxZh96QOe3SfNVyV94vAapdC7jSs17sGOpT2vCog0tg3vPew/s5oGqHYXd7CgoJRbwCXkKfJhlYkrGVRhGjgX8VUftw1VORlqjaXiKdrn9OgyE7lANm2Au/BVWQEOlPZwAtU/eDT2rUO7/ZgF/CuuHArc18rGUvF/CrTAE3N0qgqScHM/DdPgxeKWfC2l9y2BoJ78eo4v5nHqkdD9EeGX/Da6E06EDuHf9O/Dqvwe6QUEnyAIuxUdyZEPy/Y20+i342nQdlMJwmAa+K38PCjrOFvADQ0McaJn6JsOsbL/P5OgHB69cnZ6s23flgo6zBXbTXtIJ+cL/oFx/uADcwuwIneEz0B18qHKZ/j3UVafn94GCjrMFfNLN59QjpXv176nnfHfBHoXeUNAJssA22j2SI482/wPqHAftT9CYCs0mLOCu1NE6MF9577FfAz8bpkpNeaPjLTyxGJ6EN+Bj8B7bE/zPwc9BJ/AeK2Xge20x+Jq0AzxvEvhaVFDBAgULFCxQsEDBAgULFCxwTC3gK4EPJrkc00YaUdnVnLsWhh5lHXFcTfWDwU8Z73+g9CjHfVjxImLfAX9umot5J4NOoxN+2fF4NIrj8sm6ITqPQrPhooYUPsZl6mrbp31p1JtOcnaPoLL/Jjru/u2ppO4MdjCUn4BB19X2ePohjVLyKl1ITf4bR8SN99fhV6DshO+et4GzahTMB3eUZkFyCfVXiuZPBjckZoPvpL+BDfAMXABRlh8LM8D6FkB9+786ws0J32VnQwUcSfdT4HH4JrhaLYUbQfkFyTz1F1iUCdXuW08j7L+kvgv+sCBqIAHt45bnSvCHfL5XK9t6BCy/Dn4EA2A6rAfL+oVK++dr2zqsP0p/PAXa0y9cP4FiUFeCdWqX2eCF6vktINwFNXAn3J6lN0c1AQ6Cm/VPgJ1100A9DXfDSNDR5kXtI7Af/gATwfrdiNBY92bjD3CMsrztTAXr1HHvgAa4ATxfQ6ieoFGfA9ueB048yyYVx9U1m2jdtrEANLhO2QiqFzge23ESagfrs2wl3AwPged/FspAp/8dtM0/QcPHCWNbxleDdvWcb8AUcMfMT5O2dRnU1TbJGVv48UPFvmwnPAGeAs8fAyraaBPhcTATzB8Chxy8k7CGlVGgnAHLYSHoBA2alA1fBF7lVtgXlGU1mLKMHXMSRK0gYJ1RlnfwUQ8TsD4nWux8dPCDpNlXHdcWvgyWTa4IRA+NK+lgJ4ZjUmPB8yqMoNFg/BIj6HIwfivYzpngODzPSRbzCGacZ7zcCNLB1fB5IznqRPxaMP9n2bzctk22jujg2BcnbdQSAjpURRtpC6Ut7M94jR/lTLKD8ng2UcNPAmfpKohOIxhugSp4CQaB6l57yPzVmMqBbIYYN20jaLSkLBe1PBvoGBMSxwsJu4qsga3wLKgOtYd6/zpox6Tsg2pTe/jUX9tR2sJ2toC2aQ+VsBq8EK4BJ8Hb4MURtZfAazHCsQ+8Ak7uO8Dxng8NUezLq4nChh1zsv/RxtHxbZIOTpx7KNiK0PfBjjprh4Kys0/Ao9AN7oZjqTjzq+qo9H3SdsHZUJIguUKQfNSKE6x59sx12aPOS7bzQ+KWnQXa5x54F4ZBfXqGTOvuDFdDnGgEM/V5jG0bTir2RbtHGXZCuarkVbLCEZTyvhE1g8AEaA194QV4BLyflILyfBtyiWmsXIa+COfB9eAM9SrRIKpH7SH8meNtMBHugxrQ2c9DY/RB9uSvcPSKnQurYBxsA5fEwfBH0OHfgjHwJHjlJK9eop9SGSnet7vAdWA8Krftd2JG9hj78m3iVVABXgSTwPHXq7vItVAuzsj9MBZUPzgAvzaCXBp96PgYfg6e/yVQzs7JmVDtn/c4/CsRn0N4ZSJu+cXg0mI9SyEuS06mZWDb0Si3ENYJljXdiZerOK6u2YypHOM9zaRR4PmXGkEl8AqY5hXaDpzMr4Np8ibECfdiIt28NXAHqNy2THMl2AbWre3eAMuputrOrcOLzElmW9rdid4KVLwHO3FUOVjuASONkfcjO9dY6eA/gStCNCDBQ2pGyHSPUYZ1XnR6TG/ssQsVOK6kOhBJpvUmvhNcavvB5fAyONnrs4d9bQP5VFfbuWU7kRAdm5t30sZzr/iTtqPZjn2Vo1fRjeDD4gBYDo19DqCKdGomw/pBExqatw3vf3HJ3ZCNn3WyjeF/PmPRmBKd/dAAAAAASUVORK5CYII=
name: APIMetricsValidation
script:
  commands:
  - arguments: []
    description: Test Scenario One - All 10 Pass on first try
    name: test-scenario-one
    polling: true
  - arguments: []
    description: Test Scenario Two - 5 Pass on first try, 5 error on quota and are
      scheduled
    name: test-scenario-two
    polling: true
  - arguments: []
    description: Test Scenario Three - 5 Fail on second try
    name: test-scenario-three
    polling: true
  - arguments: []
    description: Test Scenario Four - 2 Succeed, 3 Fail on retry
    name: test-scenario-four
    polling: true
  - arguments: []
    description: Test Scenario Five - 10 IPs as a string, 1 success
    name: test-scenario-five
    polling: true
  - arguments: []
    description: Test Scenario Six - 10 items are in 1 call. 1 fail.
    name: test-scenario-six
    polling: true
  - arguments: []
    description: Test Scenario Seven - 10 items are in 1 call. 1 fail. No metrics
      are returned.
    name: test-scenario-seven
    polling: true
  - arguments: []
    description: Test Scenario Eight - 10 items are in 1 call. 1 fail. No metrics
      returned. Timeout.
    name: test-scenario-eight
    polling: true
  - arguments: []
    description: This is the test PB scenario
    name: test-scenario-nine
  - arguments: []
    description: This command is executed five times in the PB
    name: test-scenario-ten
  dockerimage: demisto/python3:3.10.13.72123
  runonce: false
  script: |
    register_module_line('APIMetricsValidation', 'start', __line__())
    ### pack version: 1.3.15



    TEST_BANK_SCENARIO_TEN_ITEMS = '''oneone,twotwo,threethree, fourfour, fivefive,
                             sixsix, sevenseven, eighteight, ninenine, tenten'''
    TEST_BANK_SCENARIO_FIVE_ITEMS = '''sixsix, sevenseven, eighteight, ninenine, tenten'''


    def scenario_one():
        """
        This is a test scenario where all 10 entries succeed
        Assumptions: Command has not been run before.
        Returns:
            10 successful entries
            1 ExecutionMetrics object containing 10 success
        """
        execution_metrics = ExecutionMetrics()
        command_results: list = []

        urls = argToList(TEST_BANK_SCENARIO_TEN_ITEMS)

        for url in urls:
            # Every url will pass here
            execution_metrics.success += 1
            command_results.append(
                CommandResults(readable_output=f"Item - {url} has been processed")
            )
        command_results.append(execution_metrics.metrics)
        return command_results


    def scenario_two():
        """
        This is a test scenario where 5 entries are processed and 5 are failed with QuotaError
        Assumptions: Command has not been run before.
        Returns:
            5 successful entries
            5 Scheduled entries
            1 ExecutionMetrics object containing 5 success and 5 quota errors
        """
        execution_metrics = ExecutionMetrics()
        command_results: list = []

        urls = argToList(TEST_BANK_SCENARIO_TEN_ITEMS)
        items_to_schedule = []

        for idx, url in enumerate(urls):
            # First 5 succeed
            if idx < 5:
                execution_metrics.success += 1
                command_results.append(
                    CommandResults(readable_output=f"Item - {url} has been processed")
                )
            # Next 5 fail with QuotaError
            else:
                execution_metrics.quota_error += 1
                items_to_schedule.append(url)

        scheduled_command = ScheduledCommand(
            command='test-scenario-two',
            next_run_in_seconds=20,
            args={'polling': True, 'items_to_schedule': items_to_schedule},
            timeout_in_seconds=40,
            items_remaining=len(items_to_schedule),
        )
        command_results.append(CommandResults(scheduled_command=scheduled_command))
        if execution_metrics.metrics is not None:
            command_results.append(execution_metrics.metrics)
        return command_results


    def scenario_three():
        """
        This is a test scenario where 5 entries failed with QuotaError
        Assumptions: Command has been run once before.
        Returns:
            5 Scheduled entries
            No ExecutionMetrics object
        """
        execution_metrics = ExecutionMetrics()
        command_results: list = []

        urls = argToList(TEST_BANK_SCENARIO_FIVE_ITEMS)
        items_to_schedule = []
        for idx, url in enumerate(urls):
            items_to_schedule.append(url)
            # All 5 items fail on retry here, and it's expected that all 5 iterations are previously scheduled
            continue

        scheduled_command = ScheduledCommand(
            command='test-scenario-three',
            next_run_in_seconds=20,
            args={'polling': True, 'items_to_schedule': items_to_schedule},
            timeout_in_seconds=40,
            items_remaining=len(items_to_schedule),
        )
        command_results.append(CommandResults(scheduled_command=scheduled_command))
        if execution_metrics.metrics is not None:
            command_results.append(execution_metrics.metrics)
        return command_results


    def scenario_four():
        """
        This is a test scenario where 5 entries failed with QuotaError
        Assumptions: Command has been run once before.
        Returns:
            5 Scheduled entries
            1 ExecutionMetrics object containing 2 successful
        """
        execution_metrics = ExecutionMetrics()
        command_results: list = []

        urls = argToList(TEST_BANK_SCENARIO_FIVE_ITEMS)
        items_to_schedule = []
        if not demisto.args().get('polling'):
            for idx, url in enumerate(urls):
                if idx < 2:
                    execution_metrics.success += 1
                    command_results.append(
                        CommandResults(readable_output=f"Item - {url} has been processed")
                    )
                else:
                    items_to_schedule.append(url)
                    continue

        scheduled_command = ScheduledCommand(
            command='test-scenario-four',
            next_run_in_seconds=20,
            args={'polling': True, 'items_to_schedule': items_to_schedule},
            timeout_in_seconds=40,
            items_remaining=len(items_to_schedule),
        )
        command_results.append(CommandResults(scheduled_command=scheduled_command))
        if execution_metrics.metrics is not None:
            command_results.append(execution_metrics.metrics)
        return command_results


    def scenario_five():
        """
        This is a test scenario where all 10 entries succeed
        Assumptions: Command has not been run before.
        Returns:
            1 successful entry
            1 ExecutionMetrics object containing 10 success
        """
        execution_metrics = ExecutionMetrics()
        command_results: list = []

        urls = argToList(TEST_BANK_SCENARIO_TEN_ITEMS)

        execution_metrics.success += 1
        command_results.append(
            CommandResults(readable_output=f"Item - {urls} have been processed")
        )
        command_results.append(execution_metrics.metrics)
        return command_results


    def scenario_six():
        """
        This is a test scenario where 10 items are in a single api call. That one api call fails and is scheduled.
        Assumptions: Command has not been run before.
        Returns:
            1 Scheduled entry
        """
        execution_metrics = ExecutionMetrics()
        command_results: list = []
        execution_metrics.quota_error += 1

        scheduled_command = ScheduledCommand(
            command='test-scenario-six',
            next_run_in_seconds=20,
            args={'polling': True, 'items_to_schedule': TEST_BANK_SCENARIO_TEN_ITEMS},
            timeout_in_seconds=40,
            items_remaining=len(TEST_BANK_SCENARIO_TEN_ITEMS),
        )
        command_results.append(CommandResults(scheduled_command=scheduled_command))
        if execution_metrics.metrics is not None:
            command_results.append(execution_metrics.metrics)
        return command_results


    def scenario_seven():
        """
        This is a test scenario where 10 items are in a single api call. That one api call fails and is scheduled.
        Assumptions: Command has been run once before.
        Returns:
            1 Scheduled entries
            No ExecutionMetrics object
        """
        execution_metrics = ExecutionMetrics()
        command_results: list = []
        urls = argToList(TEST_BANK_SCENARIO_TEN_ITEMS)
        items_to_schedule = [urls]

        scheduled_command = ScheduledCommand(
            command='test-scenario-seven',
            next_run_in_seconds=20,
            args={'polling': True, 'items_to_schedule': items_to_schedule},
            timeout_in_seconds=40,
            items_remaining=len(items_to_schedule),
        )
        command_results.append(CommandResults(scheduled_command=scheduled_command))
        if execution_metrics.metrics is not None:
            command_results.append(execution_metrics.metrics)
        return command_results


    def scenario_eight():
        """
        This is a test scenario where 10 items are in a single api call. That one api call fails and is scheduled.
        Assumptions: Command has been run once before. Metrics were reported the first run.
        Returns:
            1 Scheduled entries
            No ExecutionMetrics object

        Notes: To simulate that this command has been re-ran before, we are not returning _any_ metrics.
        """
        execution_metrics = ExecutionMetrics()
        command_results: list = []
        urls = argToList(TEST_BANK_SCENARIO_TEN_ITEMS)
        items_to_schedule = [urls]

        scheduled_command = ScheduledCommand(
            command='test-scenario-seven',
            next_run_in_seconds=20,
            args={'polling': True, 'items_to_schedule': items_to_schedule},
            timeout_in_seconds=40,
            items_remaining=1,
        )
        command_results.append(CommandResults(scheduled_command=scheduled_command))
        if execution_metrics.metrics is not None:
            command_results.append(execution_metrics.metrics)
        return command_results


    def scenario_nine():
        """
        This is a test scenario which is ran in a playbook
        Assumptions: Command has not been run before.
        Returns:
            10 successful entries
            1 ExecutionMetrics object containing 10 success
        """
        execution_metrics = ExecutionMetrics()
        command_results: list = []
        urls = argToList(TEST_BANK_SCENARIO_FIVE_ITEMS)

        for url in urls:
            # Every url will pass here
            execution_metrics.quota_error += 1
            command_results.append(
                CommandResults(readable_output=f"Item - {url} has been processed")
            )
        command_results.append(execution_metrics.metrics)
        return command_results


    def scenario_ten():
        """
        This is a test scenario which is returns only one successful entry.
        Assumptions: Ran only in a playbook
        Returns:
            1 successful entry
            1 ExecutionMetrics object containing 1 success
        """
        execution_metrics = ExecutionMetrics()
        command_results: list = []
        execution_metrics.success += 1
        command_results.append(
            CommandResults(readable_output="Item has been processed")
        )
        command_results.append(execution_metrics.metrics)
        return command_results


    def main():
        command = demisto.command()
        demisto.debug(f'Command being called is {command}')
        if demisto.args().get('polling') and command != 'test-scenario-four':
            # This is to isolate a scenario where the command is run in polling mode
            sys.exit(0)
        try:

            if command == 'test-scenario-one':
                results = scenario_one()
                return_results(results)

            elif command == 'test-scenario-two':
                results = scenario_two()
                return_results(results)

            elif command == 'test-scenario-three':
                results = scenario_three()
                return_results(results)

            elif command == 'test-scenario-four':
                results = scenario_four()
                return_results(results)

            elif command == 'test-scenario-five':
                results = scenario_five()
                return_results(results)

            elif command == 'test-scenario-six':
                results = scenario_six()
                return_results(results)

            elif command == 'test-scenario-seven':
                results = scenario_seven()
                return_results(results)

            elif command == 'test-scenario-eight':
                results = scenario_eight()
                return_results(results)

            elif command == 'test-scenario-nine':
                results = scenario_nine()
                return_results(results)
                return_error("This is an error")

            elif command == 'test-scenario-ten':
                results = scenario_ten()
                return_results(results)

            elif command == 'test-module':
                demisto.results('ok')
            else:
                raise NotImplementedError(f'{command} command is not implemented.')

        # Log exceptions and return errors
        except Exception as e:
            return_error(f'Failed to execute {command} command.\nError:\n{str(e)}')


    ''' ENTRY POINT '''

    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()

    register_module_line('APIMetricsValidation', 'end', __line__())
  subtype: python3
  type: python
system: true
